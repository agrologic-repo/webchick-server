<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd">
    <bean id="daoParent" abstract="true">
        <constructor-arg type="com.agrologic.app.dao.DaoFactory" ref="daoFactory"/>
    </bean>
    <bean id="alarmDao" class="com.agrologic.app.dao.mysql.impl.AlarmDaoImpl" parent="daoParent">
        <constructor-arg index="0" ref="jdbcTemplate"/>
    </bean>
    <bean id="controllerDao" class="com.agrologic.app.dao.mysql.impl.ControllerDaoImpl" parent="daoParent"/>
    <bean id="dataDao" class="com.agrologic.app.dao.mysql.impl.DataDaoImpl" parent="daoParent"/>
    <bean id="distribDao" class="com.agrologic.app.dao.mysql.impl.DistribDaoImpl" parent="daoParent"/>
    <bean id="feedDao" class="com.agrologic.app.dao.mysql.impl.FeedDaoImpl" parent="daoParent"/>
    <bean id="feedTypeDao" class="com.agrologic.app.dao.mysql.impl.FeedTypeDaoImpl" parent="daoParent"/>
    <bean id="flockDao" class="com.agrologic.app.dao.mysql.impl.FlockDaoImpl" parent="daoParent"/>
    <bean id="fuelDao" class="com.agrologic.app.dao.mysql.impl.FuelDaoImpl" parent="daoParent"/>
    <bean id="laborDao" class="com.agrologic.app.dao.mysql.impl.LaborDaoImpl" parent="daoParent"/>
    <bean id="userDao" class="com.agrologic.app.dao.mysql.impl.UserDaoImpl" parent="daoParent"/>
    <bean id="programDao" class="com.agrologic.app.dao.mysql.impl.ProgramDaoImpl" parent="daoParent"/>
    <bean id="screenDao" class="com.agrologic.app.dao.mysql.impl.ScreenDaoImpl" parent="daoParent"/>
    <bean id="tableDao" class="com.agrologic.app.dao.mysql.impl.TableDaoImpl" parent="daoParent"/>
    <bean id="schemaDao" class="com.agrologic.app.dao.mysql.impl.SchemaDaoImpl" parent="daoParent"/>
    <bean id="relayDao" class="com.agrologic.app.dao.mysql.impl.RelayDaoImpl" parent="daoParent"/>
    <bean id="systemStateDao" class="com.agrologic.app.dao.mysql.impl.SystemStateDaoImpl" parent="daoParent"/>
    <bean id="languageDao" class="com.agrologic.app.dao.mysql.impl.LanguageDaoImpl" parent="daoParent"/>
    <bean id="spreadDao" class="com.agrologic.app.dao.mysql.impl.SpreadDaoImpl" parent="daoParent"/>
    <bean id="transactionDao" class="com.agrologic.app.dao.mysql.impl.TransactionDaoImpl" parent="daoParent"/>
    <bean id="workerDao" class="com.agrologic.app.dao.mysql.impl.WorkerDaoImpl" parent="daoParent"/>
    <bean id="cellinkDao" class="com.agrologic.app.dao.mysql.impl.CellinkDaoImpl" parent="daoParent"/>
    <bean id="medicineDao" class="com.agrologic.app.dao.mysql.impl.MedicineDaoImpl" parent="daoParent"/>
    <bean id="gasDao" class="com.agrologic.app.dao.mysql.impl.GasDaoImpl" parent="daoParent"/>
    <bean id="versionDao" class="com.agrologic.app.dao.mysql.impl.VersionDaoImpl" parent="daoParent"/>
    <bean id="daoFactory" class="com.agrologic.app.dao.mysql.impl.MySqlDaoFactory" factory-method="instance"/>

    <aop:config>
        <aop:pointcut id="defaultTxPointcut" expression="within(com.agrologic.app.dao.derby.impl.DerbyAlarmDaoImpl)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="defaultTxPointcut"/>
    </aop:config>
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <constructor-arg index="0" ref="dataSource"/>
    </bean>

    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
        <property name="validateExistingTransaction" value="true"/>
    </bean>
    <!--We're wrapping our underlying data source with lazy one so that connection is not retrieved from the pool unless-->
    <!--it's really necessary. E.g. if Hibernate hits only cache, there is no need to fetch connection, but without lazy-->
    <!--data source, it will be actually fetched if service methods are marked with @Transactional-->
    <bean id="dataSource" class="org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy">
        <property name="defaultTransactionIsolationName" value="TRANSACTION_READ_COMMITTED"/>
        <property name="defaultAutoCommit" value="false"/>
        <property name="targetDataSource">
            <bean class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
                <property name="driverClass" value="com.mysql.jdbc.Driver"/>
                <property name="jdbcUrl" value="jdbc:mysql://localhost:3306/agrodb"/>
                <property name="user" value="root"/>
                <property name="password" value="agro1950"/>
                <property name="acquireRetryAttempts" value="1"/>
                <!--Every hour we'll be hitting DB to make sure MySQL doesn't kill the connection. By default if connection
                    is idle for 8 hrs, MySQL kills it-->
                <property name="idleConnectionTestPeriod" value="3600"/>
                <!--This option is useful if threads are waiting for the connection from pool. Without this threads would wait
                forever and you're risking to get your app down if all the threads stuck.-->
                <property name="checkoutTimeout" value="10000"/>
            </bean>
        </property>
    </bean>
</beans>