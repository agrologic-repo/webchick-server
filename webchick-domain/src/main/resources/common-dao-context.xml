<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd">

    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
        <constructor-arg index="0" ref="dataSource"/>
    </bean>

    <bean id="daoParent" abstract="true">
        <constructor-arg type="com.agrologic.app.dao.DaoFactory" ref="daoFactory"/>
    </bean>

    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
        <property name="validateExistingTransaction" value="true"/>
    </bean>

    <tx:advice id="txAdvice">
        <tx:attributes>
            <tx:method name="*" rollback-for="java.lang.Exception"/>
        </tx:attributes>
    </tx:advice>

    <aop:config>
        <aop:pointcut id="alarmTxPointcut" expression="within(com.agrologic.app.dao.AlarmDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="alarmTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="programAlarmTxPointcut" expression="within(com.agrologic.app.dao.ProgramAlarmDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="programAlarmTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="relayTxPointcut" expression="within(com.agrologic.app.dao.RelayDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="relayTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="programRelayTxPointcut" expression="within(com.agrologic.app.dao.ProgramRelayDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="programRelayTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="systemStateTxPointcut" expression="within(com.agrologic.app.dao.SystemStateDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="systemStateTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="programSystemStateTxPointcut"
                      expression="within(com.agrologic.app.dao.ProgramSystemStateDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="programSystemStateTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="programTxPointcut" expression="within(com.agrologic.app.dao.ProgramDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="programTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="screenTxPointcut" expression="within(com.agrologic.app.dao.ScreenDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="screenTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="tableTxPointcut" expression="within(com.agrologic.app.dao.TableDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="tableTxPointcut"/>
    </aop:config>

    <aop:config>
        <aop:pointcut id="dataTxPointcut" expression="within(com.agrologic.app.dao.DataDao+)"/>
        <aop:advisor advice-ref="txAdvice" pointcut-ref="dataTxPointcut"/>
    </aop:config>

    <!--We're wrapping our underlying data source with lazy one so that connection is not retrieved from the pool unless-->
    <!--it's really necessary. E.g. if Hibernate hits only cache, there is no need to fetch connection, but without lazy-->
    <!--data source, it will be actually fetched if i18n methods are marked with @Transactional-->
    <bean id="dataSource" class="org.springframework.jdbc.datasource.LazyConnectionDataSourceProxy">
        <property name="defaultTransactionIsolationName" value="TRANSACTION_READ_COMMITTED"/>
        <property name="defaultAutoCommit" value="false"/>
        <property name="targetDataSource">
            <bean class="com.mchange.v2.c3p0.ComboPooledDataSource" destroy-method="close">
                <property name="driverClass" value="${jdbc.driver}"/>
                <property name="jdbcUrl" value="${jdbc.url}"/>
                <property name="user" value="${jdbc.user}"/>
                <property name="password" value="${jdbc.password}"/>
                <property name="acquireRetryAttempts" value="1"/>
                <!--Every hour we'll be hitting DB to make sure MySQL doesn't kill the connection. By default if connection
                    is idle for 8 hrs, MySQL kills it-->
                <property name="idleConnectionTestPeriod" value="3600"/>
                <!--This option is useful if threads are waiting for the connection from pool. Without this threads would wait
                forever and you're risking to get your app down if all the threads stuck.-->
                <property name="checkoutTimeout" value="10000"/>
            </bean>
        </property>
    </bean>
</beans>